<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="多分頁 Ace 編輯器，支援離線 PWA、快照歷史、模式切換與多窗/行動分頁切換。">
    <title>Notelet</title>
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#111111">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <style type="text/css">
        html, body {
            overscroll-behavior-x: none;
            height: 100%;
            margin: 0;
        }

        body {
            display: flex;
            flex-direction: column;
            background: #111;
        }

        #add-editor {
            padding: 6px 10px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #2d2d2d;
            color: #f5f5f5;
            cursor: pointer;
        }

        #add-editor:hover {
            background: #3a3a3a;
        }

        #editors {
            flex: 1;
            display: flex;
            min-height: 0;
            background: #111;
        }

        #tabs {
            display: none;
            gap: 6px;
            padding: 6px 10px;
            background: #161616;
            border-bottom: 1px solid #2c2c2c;
            align-items: center;
            justify-content: space-between;
        }

        #tab-list {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            flex: 1;
        }

        #tab-actions {
            display: flex;
            gap: 6px;
            align-items: center;
            margin-left: 8px;
        }

        .tab-btn {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #2f2f2f;
            background: #1f1f1f;
            color: #f0f0f0;
            cursor: pointer;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .tab-btn.active {
            background: #2d2d2d;
            border-color: #3a6df0;
        }

        .tab-action {
            width: 34px;
            height: 32px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .pane-close {
            position: absolute;
            top: 6px;
            right: 8px;
            z-index: 2;
            width: 22px;
            height: 22px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #2d2d2d;
            color: #f5f5f5;
            cursor: pointer;
            font-size: 14px;
            line-height: 20px;
            padding: 0;
        }

        .pane-close:hover {
            background: #3a3a3a;
        }

        .tab-action .icon {
            margin-right: 0;
        }

        .tab-close {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 1px solid #2f2f2f;
            background: #1f1f1f;
            color: #cfcfcf;
            cursor: pointer;
            font-size: 12px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .pane {
            position: relative;
            flex: 1 1 0;
            min-width: 140px;
            border-right: 1px solid #222;
        }

        .pane:last-of-type {
            border-right: none;
        }

        .ace-host {
            font-size: 16px;
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }

        .resizer {
            box-sizing: border-box;
            width: 6px;
            flex: 0 0 6px;
            cursor: col-resize;
            background: #2a2a2a;
            border-left: 1px solid #1b1b1b;
            border-right: 1px solid #1b1b1b;
        }

        .resizer:hover {
            background: #3a3a3a;
        }

        .pane.hidden {
            display: none;
        }

        #status {
            box-sizing: border-box;
            height: 36px;
            padding: 0 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-family: Arial, sans-serif;
            font-size: 11px;
            background: linear-gradient(180deg, #1f1f1f 0%, #161616 100%);
            color: #e6e6e6;
            border-top: 1px solid #2c2c2c;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.25);
        }

        #status-text {
            white-space: nowrap;
            color: #b8bcc3;
            padding: 0;
        }

        #status-left {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #b8bcc3;
        }

        #status-tools {
            display: flex;
            align-items: center;
            gap: 10px;
        }


        #mode-select {
            height: 28px;
            background: #2d2d2d;
            color: #f5f5f5;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 0 8px;
        }

        #load-latest,
        #open-history,
        #history-close {
            padding: 6px 10px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #2d2d2d;
            color: #f5f5f5;
            cursor: pointer;
        }

        #load-latest:hover,
        #open-history:hover,
        #history-close:hover {
            background: #3a3a3a;
        }

        #mode-select {
            height: 28px;
            background: transparent;
            color: #e0e0e0;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
        }

        .status-action {
            width: 32px;
            height: 28px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            border: 1px solid #2f2f2f;
            background: #1f1f1f;
            color: #f0f0f0;
            cursor: pointer;
        }

        .status-action:hover {
            background: #2a2a2a;
        }

        .icon {
            display: inline-block;
            width: 14px;
            height: 14px;
            margin-right: 6px;
            background: currentColor;
            mask-size: contain;
            mask-repeat: no-repeat;
            mask-position: center;
            -webkit-mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            -webkit-mask-position: center;
            opacity: 0.9;
            vertical-align: middle;
        }

        .icon-refresh {
            mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10m-2.51 5a9 9 0 0 1-14.85 3.36L1 14"/></svg>');
            -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10m-2.51 5a9 9 0 0 1-14.85 3.36L1 14"/></svg>');
        }

        .icon-history {
            mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 7 3 21 21 21 21 7"/><path d="M7 3h10v4H7z"/><path d="M9 12h6M9 16h6"/></svg>');
            -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 7 3 21 21 21 21 7"/><path d="M7 3h10v4H7z"/><path d="M9 12h6M9 16h6"/></svg>');
        }

        .icon-add {
            mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>');
            -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>');
        }

        .icon-format {
            mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16"/><path d="M4 10h10"/><path d="M4 14h16"/><path d="M4 18h8"/></svg>');
            -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16"/><path d="M4 10h10"/><path d="M4 14h16"/><path d="M4 18h8"/></svg>');
        }

        .icon-compact {
            mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="5" width="16" height="4" rx="1"/><rect x="4" y="15" width="16" height="4" rx="1"/></svg>');
            -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="5" width="16" height="4" rx="1"/><rect x="4" y="15" width="16" height="4" rx="1"/></svg>');
        }

        .icon-grid {
            display: inline-block;
            width: 18px;
            height: 18px;
            background: currentColor;
            mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="8" height="8" rx="1.5"/><rect x="13" y="3" width="8" height="8" rx="1.5"/><rect x="3" y="13" width="8" height="8" rx="1.5"/><rect x="13" y="13" width="8" height="8" rx="1.5"/></svg>');
            -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="8" height="8" rx="1.5"/><rect x="13" y="3" width="8" height="8" rx="1.5"/><rect x="3" y="13" width="8" height="8" rx="1.5"/><rect x="13" y="13" width="8" height="8" rx="1.5"/></svg>');
            mask-size: contain;
            mask-repeat: no-repeat;
            mask-position: center;
            -webkit-mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            -webkit-mask-position: center;
        }

        #history-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        #history-modal {
            width: min(900px, 90vw);
            max-height: 80vh;
            overflow: auto;
            background: #1c1c1c;
            border: 1px solid #2a2a2a;
            border-radius: 10px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            padding: 18px;
            color: #f5f5f5;
            font-family: Arial, sans-serif;
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            #tabs {
                display: flex;
                flex-wrap: wrap;
            }

            #status {
                flex-direction: column;
                align-items: flex-start;
                height: auto;
                gap: 8px;
                padding: 8px 12px;
            }

            #status-left,
            #status-tools {
                width: 100%;
                flex-wrap: wrap;
                justify-content: flex-start;
            }

            #status-tools {
                display: none;
            }

            #editors {
                flex-direction: column;
            }

            .pane {
                width: 100%;
                flex: 1 1 auto;
            }

            .resizer {
                display: none;
            }

            .pane-close {
                display: none;
            }

            #history-modal {
                width: 95vw;
            }

            #history-list {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
        }

        #history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        #history-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .history-card {
            border: 1px solid #2f2f2f;
            border-radius: 8px;
            padding: 10px;
            background: #242424;
            cursor: pointer;
            transition: transform 0.1s ease, border-color 0.1s ease;
            min-height: 110px;
            display: flex;
            flex-direction: column;
            position: relative;
            padding-bottom: 26px;
        }

        .history-card:hover {
            transform: translateY(-2px);
            border-color: #3a6df0;
        }

        .history-time {
            font-size: 12px;
            color: #cfcfcf;
            margin: 0 0 10px;
        }

        .history-mode {
            font-size: 12px;
            color: #9da2ab;
            position: absolute;
            right: 6px;
            top: 6px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid #303030;
            border-radius: 6px;
            padding: 2px 6px;
            pointer-events: none;
        }

        .history-delete {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 22px;
            height: 22px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #2d2d2d;
            color: #f5f5f5;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            line-height: 1;
        }

        .history-delete:hover {
            background: #3a3a3a;
        }

        .history-preview {
            font-size: 12px;
            color: #e0e0e0;
            white-space: pre-wrap;
            overflow: hidden;
            max-height: 140px;
            padding: 8px;
            background: #1b1b1b;
            border: 1px solid #2a2a2a;
            border-radius: 6px;
            position: relative;
        }

        #modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1100;
        }

        #modal {
            min-width: 280px;
            max-width: 420px;
            background: #1f1f1f;
            border: 1px solid #2e2e2e;
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            padding: 18px;
            color: #f5f5f5;
            font-family: Arial, sans-serif;
        }

        #modal-message {
            margin: 0 0 16px;
            line-height: 1.4;
        }

        #modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        #toast {
            position: fixed;
            left: 12px;
            bottom: 52px;
            max-width: 340px;
            background: rgba(28, 28, 28, 0.92);
            color: #f0f0f0;
            border: 1px solid #2f2f2f;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 12px;
            line-height: 1.4;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
            display: none;
            z-index: 1200;
        }

        .modal-btn {
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid #444;
            cursor: pointer;
            background: #2d2d2d;
            color: #f5f5f5;
        }

        .modal-btn.primary {
            background: #3a6df0;
            border-color: #2f55c6;
        }

        .modal-btn:hover {
            opacity: 0.9;
        }
    </style>
</head>

<body>
    <div id="tabs">
        <div id="tab-list"></div>
        <div id="tab-actions">
            <button id="tab-add" class="tab-btn tab-action" title="Add editor"><span class="icon icon-add" aria-hidden="true"></span></button>
            <button id="tab-load" class="tab-btn tab-action" title="Load latest"><span class="icon icon-refresh" aria-hidden="true"></span></button>
            <button id="tab-history" class="tab-btn tab-action" title="History"><span class="icon icon-history" aria-hidden="true"></span></button>
        </div>
    </div>
    <div id="editors"></div>
    <div id="status">
            <div id="status-left">
                <div id="status-text">Ln 1, Col 1</div>
                <select id="mode-select" aria-label="Mode">
                <option value="ace/mode/text">text</option>
                    <option value="ace/mode/json">json</option>
                    <option value="ace/mode/javascript">javascript</option>
                    <option value="ace/mode/css">css</option>
                    <option value="ace/mode/xml">xml</option>
                    <option value="ace/mode/markdown">markdown</option>
                </select>
                <button id="format-pretty" class="status-action" title="格式化 (Pretty)"><span class="icon icon-format" aria-hidden="true"></span></button>
                <button id="format-compact" class="status-action" title="壓縮 (Compact)"><span class="icon icon-compact" aria-hidden="true"></span></button>
            </div>
        <div id="status-tools">
            <button id="load-latest"><span class="icon icon-refresh" aria-hidden="true"></span>Load latest</button>
            <button id="open-history"><span class="icon icon-history" aria-hidden="true"></span>History</button>
            <button id="add-editor"><span class="icon icon-add" aria-hidden="true"></span>Add editor</button>
        </div>
    </div>
    <div id="history-overlay">
        <div id="history-modal">
            <div id="history-header">
                <strong>歷史紀錄</strong>
                <button id="history-close" class="modal-btn">關閉</button>
            </div>
            <div id="history-list"></div>
        </div>
    </div>
    <div id="modal-overlay">
        <div id="modal">
            <p id="modal-message"></p>
            <div id="modal-actions">
                <button id="modal-cancel" class="modal-btn">取消</button>
                <button id="modal-ok" class="modal-btn primary">確定</button>
            </div>
        </div>
    </div>
    <div id="toast"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.3/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsonlint/1.6.0/jsonlint.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.9/beautify.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.9/beautify-css.min.js" type="text/javascript" charset="utf-8"></script>
    <script>
    (() => {
        const container = document.getElementById('editors');
        const tabs = document.getElementById('tabs');
        const tabList = document.getElementById('tab-list');
        const tabLoad = document.getElementById('tab-load');
        const tabHistory = document.getElementById('tab-history');
        const tabAdd = document.getElementById('tab-add');
        const addButton = document.getElementById('add-editor');
        const modeSelect = document.getElementById('mode-select');
        const statusText = document.getElementById('status-text');
        const formatPretty = document.getElementById('format-pretty');
        const formatCompact = document.getElementById('format-compact');
        const loadLatestBtn = document.getElementById('load-latest');
        const historyBtn = document.getElementById('open-history');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalMessage = document.getElementById('modal-message');
        const modalOk = document.getElementById('modal-ok');
        const modalCancel = document.getElementById('modal-cancel');
        const historyOverlay = document.getElementById('history-overlay');
        const historyList = document.getElementById('history-list');
        const historyClose = document.getElementById('history-close');
        const toast = document.getElementById('toast');
        let activeEditor = null;
        let currentMode = modeSelect.value;
        let editors = [];

        const isMobile = () => window.innerWidth <= 768;

        const DB_NAME = 'notelet-db';
        const DB_VERSION = 1;
        const STORE = 'sessions';
        const MAX_SESSIONS = 20;
        const RESIZER_WIDTH = 7;

        const openDb = () => new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(STORE)) {
                    db.createObjectStore(STORE, { keyPath: 'id' });
                }
            };
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });

        const putSession = async (session) => {
            const db = await openDb();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE, 'readwrite');
                const store = tx.objectStore(STORE);
                const req = store.put(session);
                req.onsuccess = () => resolve();
                req.onerror = () => reject(req.error);
            });
        };

        const deleteSession = async (id) => {
            const db = await openDb();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE, 'readwrite');
                const store = tx.objectStore(STORE);
                const req = store.delete(id);
                req.onsuccess = () => resolve();
                req.onerror = () => reject(req.error);
            });
        };

        const getAllSessions = async () => {
            const db = await openDb();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE, 'readonly');
                const store = tx.objectStore(STORE);
                const req = store.getAll();
                req.onsuccess = () => resolve(req.result || []);
                req.onerror = () => reject(req.error);
            });
        };

        const hashString = (str) => {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = (hash * 31 + str.charCodeAt(i)) | 0;
            }
            return (hash >>> 0).toString(16).padStart(8, '0');
        };

        const generateSessionId = () => `page-${Date.now().toString(16)}-${Math.random().toString(16).slice(2, 8)}`;

        const detectModeFromText = (text) => {
            if (typeof text !== 'string') return null;
            const trimmed = text.trim();
            if (!trimmed) return null;
            const lower = trimmed.toLowerCase();

            // JSON detection
            if ((trimmed.startsWith('{') || trimmed.startsWith('['))) {
                try {
                    JSON.parse(trimmed);
                    return 'ace/mode/json';
                } catch (_) {}
            }

            // JavaScript cues
            if (/(function\s+\w+)|(=>)|(^|\n)\s*(const|let|var)\s+\w+/.test(trimmed)) {
                return 'ace/mode/javascript';
            }

            // XML / HTML-ish
            if (/^<[^>]+>/.test(trimmed)) {
                return 'ace/mode/xml';
            }

            // CSS
            if (/^[^{]+\{[^}]*:[^}]*\}/m.test(trimmed)) {
                return 'ace/mode/css';
            }

            // Markdown indicators
            if (/^\s{0,3}#\s+.+/m.test(trimmed) || /^[-*]_\s*[-*]_\s*[-*]_/.test(trimmed) || /^>\s+.+/m.test(trimmed)) {
                return 'ace/mode/markdown';
            }
            return null;
        };

        const askConfirm = (message) => new Promise((resolve) => {
            modalMessage.textContent = message;
            modalOverlay.style.display = 'flex';
            const cleanup = () => {
                modalOverlay.style.display = 'none';
                modalOk.onclick = null;
                modalCancel.onclick = null;
            };
            modalOk.onclick = () => {
                cleanup();
                resolve(true);
            };
            modalCancel.onclick = () => {
                cleanup();
                resolve(false);
            };
        });

        const listSessions = async () => {
            const sessions = await getAllSessions();
            return (sessions || []).sort((a, b) => b.updatedAt - a.updatedAt);
        };

        const pruneSessions = async () => {
            const sessions = await listSessions();
            if (sessions.length <= MAX_SESSIONS) return;
            const toDrop = sessions.slice(MAX_SESSIONS);
            await Promise.all(toDrop.map(({ id }) => deleteSession(id)));
        };

        const persistPage = async () => {
            const snapshot = editors.map(ed => ({
                content: ed.getValue(),
                mode: ed.session.$modeId
            }));
            const updatedAt = Date.now();
            const hasContent = snapshot.some(e => e.content.trim().length > 0);
            if (!hasContent) {
                // empty page -> clear history
                return;
            }
            await putSession({ id: pageId, editors: snapshot, updatedAt });
            await pruneSessions();
        };

        const updateStatus = () => {
            if (!activeEditor) return;
            const { row, column } = activeEditor.getCursorPosition();
            const totalChars = activeEditor.getValue().length;
            const encoder = new TextEncoder();
            const bytes = encoder.encode(activeEditor.getValue()).length;
            statusText.textContent = `Ln ${row + 1}, Col ${column + 1} | Chars ${totalChars} | Bytes ${bytes}`;
        };

        const updateCloseButtons = () => {
            const show = !isMobile() && editors.length > 1;
            editors.forEach(ed => {
                const pane = ed.__pane;
                const btn = pane?.querySelector('.pane-close');
                if (btn) btn.style.display = show ? 'block' : 'none';
            });
        };

        const renderTabs = () => {
            if (!isMobile()) {
                tabList.innerHTML = '';
                return;
            }
            tabList.innerHTML = '';
            const showClose = editors.length > 1;
            editors.forEach((ed, idx) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'tab-btn' + (ed === activeEditor ? ' active' : '');

                const label = document.createElement('span');
                label.textContent = `Ed ${idx + 1}`;
                wrapper.appendChild(label);

                const close = document.createElement('button');
                close.className = 'tab-close';
                close.textContent = '×';
                close.style.display = showClose ? 'inline-flex' : 'none';
                close.addEventListener('click', async (ev) => {
                    ev.stopPropagation();
                    const ok = await askConfirm('要關閉這個編輯器嗎？');
                    if (!ok) return;
                    removePane(ed.__pane, ed);
                });
                wrapper.appendChild(close);

                wrapper.addEventListener('click', () => setActiveEditor(ed));
                tabList.appendChild(wrapper);
            });
        };

        const updatePaneVisibility = () => {
            const mobile = isMobile();
            editors.forEach(ed => {
                const pane = ed.__pane;
                if (!pane) return;
                if (mobile) {
                    pane.classList.toggle('hidden', ed !== activeEditor);
                } else {
                    pane.classList.remove('hidden');
                }
            });
        };

        const layoutPanes = (panes) => {
            const mobile = isMobile();
            const resizerCount = Math.max(0, panes.length - 1);
            const width = container.clientWidth || container.getBoundingClientRect().width;
            const available = Math.max(0, width - resizerCount * RESIZER_WIDTH);
            const basis = panes.length ? available / panes.length : 0;
            container.innerHTML = '';
            panes.forEach((pane, index) => {
                if (mobile) {
                    pane.style.flex = '1 1 auto';
                    pane.style.width = '100%';
                    container.appendChild(pane);
                } else {
                    if (basis > 0) {
                        pane.style.flex = `0 0 ${basis}px`;
                    } else {
                        pane.style.flex = '1 1 0';
                    }
                    container.appendChild(pane);
                    if (index < panes.length - 1) {
                        const resizer = makeResizer(pane, panes[index + 1]);
                        container.appendChild(resizer);
                    }
                }
            });
            updateCloseButtons();
            updatePaneVisibility();
            renderTabs();
        };

        const removePane = (pane, editorInstance) => {
            editors = editors.filter(ed => ed !== editorInstance);
            const panes = editors.map(ed => ed.__pane).filter(Boolean);
            layoutPanes(panes);

            if (activeEditor === editorInstance) {
                const nextEditor = editors[0] || null;
                if (nextEditor) {
                    setActiveEditor(nextEditor);
                } else {
                    activeEditor = null;
                    statusText.textContent = 'Ln 1, Col 1 | Chars 0';
                }
            }

            persistPage();
        };

        const setActiveEditor = (editorInstance) => {
            activeEditor = editorInstance;
            const modeId = editorInstance.session.$modeId || currentMode;
            currentMode = modeId;
            if (modeSelect.value !== modeId) {
                modeSelect.value = modeId;
            }
            renderTabs();
            updatePaneVisibility();
            updateSavedOptions();
            updateStatus();
            formatPretty.style.display = isFormatSupported(modeId) ? 'inline-flex' : 'none';
            formatCompact.style.display = simplifyMode(modeId) === 'json' ? 'inline-flex' : 'none';
        };

        const registerSaveCommand = (editorInstance) => {
            editorInstance.commands.addCommand({
                name: 'saveToFile',
                bindKey: { win: 'Ctrl-S', mac: 'Command-S' },
                exec: function (ed) {
                    const content = ed.getValue();
                    const downloadName = `${hashString(content)}.txt`;
                    const url = window.URL.createObjectURL(new Blob([ed.getValue()], {
                        type: 'text/plain; charset=UTF-8'
                    }));
                    let a = document.createElement('a');
                    a.href = url;
                    a.download = downloadName;
                    a.click();
                    window.URL.revokeObjectURL(url);
                },
                readOnly: true
            });
        };

        const attachEditorEvents = (editorInstance) => {
            editorInstance.selection.on('changeCursor', updateStatus);
            editorInstance.session.on('change', () => {
                if (editorInstance.__suppressPersist) {
                    editorInstance.__suppressPersist = false;
                    updateStatus();
                    return;
                }
                updateStatus();
                persistPage();
            });
            editorInstance.on('focus', () => setActiveEditor(editorInstance));
            editorInstance.on('paste', (pasted) => {
                if (editorInstance.getValue().trim().length > 0) return;
                let text = '';
                if (typeof pasted === 'string') {
                    text = pasted;
                } else if (Array.isArray(pasted)) {
                    text = pasted.join('\n');
                } else if (pasted && typeof pasted.text === 'string') {
                    text = pasted.text;
                }
                const detected = detectModeFromText(text);
                if (detected && detected !== editorInstance.session.getMode()?.$id) {
                    editorInstance.session.setMode(detected);
                    currentMode = detected;
                    if (modeSelect.value !== detected) modeSelect.value = detected;
                    formatPretty.style.display = isFormatSupported(detected) ? 'inline-flex' : 'none';
                    formatCompact.style.display = simplifyMode(detected) === 'json' ? 'inline-flex' : 'none';
                }
            });
            registerSaveCommand(editorInstance);
        };

        const createPane = () => {
            const pane = document.createElement('div');
            pane.className = 'pane';

            const closeBtn = document.createElement('button');
            closeBtn.className = 'pane-close';
            closeBtn.textContent = '×';
            pane.appendChild(closeBtn);

            const editorEl = document.createElement('div');
            editorEl.className = 'ace-host';
            pane.appendChild(editorEl);

            const editorInstance = ace.edit(editorEl);
            editorInstance.__sessionId = generateSessionId();
            editorInstance.__suppressPersist = false;
            editorInstance.__formatCompact = false;
            editorInstance.__pane = pane;
            pane.__editorInstance = editorInstance;
            editorInstance.setTheme('ace/theme/monokai');
            editorInstance.session.setMode(currentMode);
            attachEditorEvents(editorInstance);

            closeBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const ok = await askConfirm('要關閉這個編輯器嗎？');
                if (!ok) return;
                removePane(pane, editorInstance);
            });

            if (!activeEditor) setActiveEditor(editorInstance);

            return { pane, editorInstance };
        };

        const makeResizer = (leftPane, rightPane) => {
            const resizer = document.createElement('div');
            resizer.className = 'resizer';
            let startX = 0;
            let leftStart = 0;
            let rightStart = 0;

            const onMouseMove = (e) => {
                const dx = e.clientX - startX;
                const total = leftStart + rightStart;
                let newLeft = leftStart + dx;
                newLeft = Math.max(80, Math.min(total - 80, newLeft));
                const newRight = total - newLeft;
                leftPane.style.flex = `0 0 ${newLeft}px`;
                rightPane.style.flex = `0 0 ${newRight}px`;
            };

            const onMouseUp = () => {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                document.body.style.userSelect = '';
            };

            resizer.addEventListener('mousedown', (e) => {
                startX = e.clientX;
                leftStart = leftPane.getBoundingClientRect().width;
                rightStart = rightPane.getBoundingClientRect().width;
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
                document.body.style.userSelect = 'none';
            });

            return resizer;
        };

        const updateSavedOptions = async () => {
            // no-op placeholder (history modal fetches sessions on open)
        };

        const addEditorPane = (initialContent = '', initialMode = currentMode, suppressPersist = false) => {
            const { pane, editorInstance } = createPane();
            editors.push(editorInstance);
            const panes = Array.from(container.querySelectorAll('.pane'));
            panes.push(pane);
            layoutPanes(panes);

            editorInstance.session.setMode(initialMode || currentMode);
            if (initialContent !== undefined && initialContent !== null) {
                if (suppressPersist) editorInstance.__suppressPersist = true;
                editorInstance.setValue(initialContent, -1);
            }

            setActiveEditor(editorInstance);
        };

        window.addEventListener('resize', () => {
            const panes = editors.map(ed => ed.__pane).filter(Boolean);
            layoutPanes(panes);
        });

        const handleAddEditor = () => addEditorPane();

        addButton.addEventListener('click', handleAddEditor);

        modeSelect.addEventListener('change', (e) => {
            currentMode = e.target.value;
            if (activeEditor) {
                activeEditor.session.setMode(currentMode);
                persistPage();
                formatPretty.style.display = isFormatSupported(currentMode) ? 'inline-flex' : 'none';
                formatCompact.style.display = simplifyMode(currentMode) === 'json' ? 'inline-flex' : 'none';
            }
        });

        formatPretty.addEventListener('click', () => handleFormat('pretty'));
        formatCompact.addEventListener('click', () => handleFormat('compact'));

        const applySnapshot = (snapshot, replace = false) => {
            if (!snapshot) return;
            let editorsData = snapshot.editors;
            // backward compatibility: older entries may store single content/mode
            if (!Array.isArray(editorsData)) {
                editorsData = [{ content: snapshot.content || '', mode: snapshot.mode || currentMode }];
            }
            if (replace) {
                editors = [];
                container.innerHTML = '';
            }
            editorsData.forEach(ed => {
                addEditorPane(ed.content || '', ed.mode || currentMode, true);
            });
            setActiveEditor(editors[editors.length - 1]);
            pageId = generateSessionId();
        };

        const formatters = {
            json: {
                pretty: (val) => JSON.stringify(parseJsonSafe(val), null, 2),
                compact: (val) => JSON.stringify(parseJsonSafe(val))
            },
            xml: {
                pretty: (val) => {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(val, 'application/xml');
                    const err = xmlDoc.querySelector('parsererror');
                    if (err) throw new Error('Invalid XML');
                    const serializer = new XMLSerializer();
                    const raw = serializer.serializeToString(xmlDoc).replace(/>\s*</g, '><');
                    const lines = raw.replace(/></g, '>\n<').split('\n');
                    let depth = 0;
                    const formatted = lines.map(line => {
                        const trimmed = line.trim();
                        const isClosing = /^<\//.test(trimmed);
                        const isSelf = /<[^>]+\/>$/.test(trimmed);
                        const isOpening = /^<[^!?][^>]*[^\/]?>$/.test(trimmed) && !isSelf && !/^<.*><\/.*>$/.test(trimmed);
                        if (isClosing) depth = Math.max(depth - 1, 0);
                        const pad = '  '.repeat(depth);
                        if (isOpening) depth += 1;
                        return pad + trimmed;
                    }).join('\n');
                    return formatted;
                },
                compact: (val) => {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(val, 'application/xml');
                    const err = xmlDoc.querySelector('parsererror');
                    if (err) throw new Error('Invalid XML');
                    const serializer = new XMLSerializer();
                    return serializer.serializeToString(xmlDoc).replace(/>\s+</g, '><');
                }
            },
            javascript: {
                pretty: (val) => {
                    if (window.js_beautify) return js_beautify(val, { indent_size: 2 });
                    return val;
                },
                compact: (val) => {
                    if (window.js_beautify) return js_beautify(val, { indent_size: 0, preserve_newlines: false });
                    return val.replace(/\s+/g, ' ').trim();
                }
            },
            css: {
                pretty: (val) => {
                    if (window.css_beautify) return css_beautify(val, { indent_size: 2 });
                    return val;
                },
                compact: (val) => {
                    if (window.css_beautify) return css_beautify(val, { indent_size: 0, preserve_newlines: false });
                    return val.replace(/\s+/g, ' ').trim();
                }
            },
            markdown: {
                pretty: (val) => val,
                compact: (val) => val.replace(/\s+/g, ' ').trim()
            }
        };

        const handleFormat = (kind) => {
            if (!activeEditor) return;
            const ed = activeEditor;
            const modeId = ed.session.$modeId || currentMode;
            const key = simplifyMode(modeId);
            if (!isFormatSupported(key)) return;
            if (kind === 'compact' && key !== 'json') return;
            const fmt = formatters[key] || formatters.json;
            const val = ed.getValue();
            let next = val;
            try {
                next = fmt[kind] ? fmt[kind](val) : val;
            } catch (e) {
                console.error('format failed', e);
                const msg = e && e.message ? e.message : '格式化失敗';
                showToast(`格式化失敗：${msg}`);
                return;
            }
            ed.__suppressPersist = false;
            ed.setValue(next, -1);
            persistPage();
        };

        const handleLoadLatest = async () => {
            const sessions = await listSessions();
            if (!sessions.length) return;
            const latest = sessions[0];
            const hasContent = editors.some(ed => ed.getValue().trim().length > 0);
            if (hasContent) {
                window.open(`./?load=${encodeURIComponent(latest.id)}`, '_blank');
            } else {
                applySnapshot(latest, true);
            }
        };

        const simplifyMode = (mode) => {
            if (!mode) return 'text';
            const parts = mode.split('/');
            return parts[parts.length - 1];
        };

        const parseJsonSafe = (val) => {
            if (window.jsonlint && typeof jsonlint.parse === 'function') {
                return jsonlint.parse(val);
            }
            return JSON.parse(val);
        };

        const showToast = (msg) => {
            toast.textContent = msg;
            toast.style.display = 'block';
            clearTimeout(showToast._t);
            showToast._t = setTimeout(() => {
                toast.style.display = 'none';
            }, 4000);
        };

        let pageId = generateSessionId();

        const isFormatSupported = (modeId) => {
            const m = simplifyMode(modeId);
            return ['json', 'xml', 'javascript', 'css', 'markdown'].includes(m);
        };

        const renderHistoryCards = async () => {
            const currentId = activeEditor ? activeEditor.__sessionId : null;
            const sessions = (await listSessions()).filter(s => s.id !== currentId);
            historyList.innerHTML = '';
            if (!sessions.length) {
                historyList.innerHTML = '<div style="color:#ccc;">目前沒有歷史紀錄</div>';
                return;
            }
            sessions.forEach(s => {
                const card = document.createElement('div');
                card.className = 'history-card';

                const delBtn = document.createElement('button');
                delBtn.className = 'history-delete';
                delBtn.textContent = '×';
                card.appendChild(delBtn);

                const time = document.createElement('div');
                time.className = 'history-time';
                time.textContent = new Date(s.updatedAt).toLocaleString();
                const preview = document.createElement('div');
                preview.className = 'history-preview';
                const first = (s.editors && s.editors[0]?.content) || '';
                const snippet = first.split('\n').slice(0, 7).join('\n');
                preview.textContent = snippet;
                const mode = document.createElement('div');
                mode.className = 'history-mode';
                const firstMode = (s.editors && s.editors[0]?.mode) || s.mode;
                mode.textContent = simplifyMode(firstMode);
                preview.appendChild(mode);
                card.appendChild(time);
                card.appendChild(preview);

                card.addEventListener('click', () => {
                    const hasContent = editors.some(ed => ed.getValue().trim().length > 0);
                    if (hasContent) {
                        window.open(`./?load=${encodeURIComponent(s.id)}`, '_blank');
                    } else {
                        applySnapshot(s, true);
                    }
                    historyOverlay.style.display = 'none';
                });

                delBtn.addEventListener('click', async (ev) => {
                    ev.stopPropagation();
                    const ok = await askConfirm('要刪除這筆歷史紀錄嗎？');
                    if (!ok) return;
                    await deleteSession(s.id);
                    renderHistoryCards();
                });

                historyList.appendChild(card);
            });
        };

        const handleOpenHistory = async () => {
            await renderHistoryCards();
            historyOverlay.style.display = 'flex';
        };

        historyBtn.addEventListener('click', handleOpenHistory);

        historyClose.addEventListener('click', () => {
            historyOverlay.style.display = 'none';
        });

        window._txt = Object.freeze({
            getEditors: () => editors.slice(),
            getActiveEditor: () => activeEditor,
            getActiveIndex: () => editors.indexOf(activeEditor),
            getValue: (index = editors.indexOf(activeEditor)) => editors[index]?.getValue() ?? '',
            getValues: () => editors.map((ed, idx) => ({ index: idx, mode: ed.session.$modeId, value: ed.getValue() })),
            focus: (index = 0) => {
                const ed = editors[index];
                if (ed) {
                    ed.focus();
                    setActiveEditor(ed);
                }
                return ed;
            }
        });

        const handleTabLoad = async (e) => {
            e.stopPropagation();
            await handleLoadLatest();
        };

        const handleTabHistory = async (e) => {
            e.stopPropagation();
            await handleOpenHistory();
        };

        const handleTabAdd = (e) => {
            e.stopPropagation();
            handleAddEditor();
        };

        loadLatestBtn.addEventListener('click', handleLoadLatest);
        tabLoad.addEventListener('click', handleTabLoad);
        tabHistory.addEventListener('click', handleTabHistory);
        tabAdd.addEventListener('click', handleTabAdd);

        addEditorPane();

        const params = new URLSearchParams(window.location.search);
        const loadId = params.get('load');
        if (loadId) {
            listSessions().then(sessions => {
                const found = sessions.find(s => s.id === loadId);
                if (found) {
                    applySnapshot(found, true);
                    history.replaceState({}, document.title, './');
                }
            });
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(() => {});
            });
        }
        
        const hasAnyContent = () => editors.some(ed => ed.getValue().trim().length > 0);

        window.onbeforeunload = () => {
            if (!hasAnyContent()) return undefined;
            return '您有尚未保存的內容，確定要離開嗎？';
        };
        renderTabs();
        updatePaneVisibility();
        formatPretty.style.display = isFormatSupported(currentMode) ? 'inline-flex' : 'none';
        formatCompact.style.display = simplifyMode(currentMode) === 'json' ? 'inline-flex' : 'none';
    })();
    </script>
</body>
